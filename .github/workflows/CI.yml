name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
env:
  WINDOWS_PACKAGE_PATH: 'src\MachineDashboard\bin\Release\net6.0\win-x86\publish\'
  LINUX_PACKAGE_PATH:   'src\MachineDashboard\bin\Release\net6.0\linux-x64\publish\'

jobs:
  build:

    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v2
    - name: Setup .NET
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 6.0.x
        include-prerelease: true

    - name: Restore dependencies
      run: dotnet restore .\MachineDashboard.sln
      
    - name: Edit property string value in appsettings.json
      uses: benday-inc/set-property-value-in-appsettings@main
      with:
        pathtosettingsfile: 'src/MachineDashboard/appsettings.json'
        keyname1: 'ConnectionString'
        valuetoset: 'the new value'

    - name: Publish for Windows
      run: dotnet publish .\src\MachineDashboard --runtime win-x86 --self-contained true -c=Release /p:PublishSingleFile=true /p:IncludeNativeLibrariesForSelfExtract=true /p:PublishReadyToRun=true

    - name: Build MachineDashboard-win-x86.zip
      uses: actions/upload-artifact@v1.0.0
      with:
        name: MachineDashboard-win-x86.zip
        path: ${{ env.WINDOWS_PACKAGE_PATH }}

    - name: Publish for Linux
      run: dotnet publish .\src\MachineDashboard --runtime linux-x64 --self-contained true -c=Release /p:PublishSingleFile=true /p:IncludeNativeLibrariesForSelfExtract=true /p:PublishReadyToRun=true

    - name: Build MachineDashboard-linux-x64.zip
      uses: actions/upload-artifact@v1.0.0
      with:
        name: MachineDashboard-linux-x64.zip
        path: ${{ env.LINUX_PACKAGE_PATH }}
